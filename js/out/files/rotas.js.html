<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>rotas.js</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title=""></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/Rotas.html">Rotas</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/Rotas.html">Rotas</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: rotas.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
* @module Rotas
*/
/**
* Toda a gestão das rotas deverá passar por aqui
* @class Rotas
* @constructor
*/
Rotas = {
    /**
    * ID do formulário com as opções de pesquisa
    * @property formulario
    * @type {String}
    * @default &quot;#trip_plan_form&quot;
    * @example &#x60;&lt;form class=&quot;form-horizontal&quot; role=&quot;form&quot; id=&quot;trip_plan_form&quot;&gt;&#x60;
    */
    formulario:             &#x27;#trip_plan_form&#x27;,
    /**
    * Qual a API que será consumida
    * @property tipo_api
    * @type {String}
    * @default &quot;otp&quot;
    */
    tipo_api:               &#x27;otp&#x27;,
    /**
    * Distância a pé
    * @property distanciaPe
    * @type {Int}
    * @default &quot;0&quot;
    */
    distanciaPe:            0,
    /**
    * Distância por transportes
    * @property distanciaTransporte
    * @type {Int}
    * @default &quot;0&quot;
    */
    distanciaTransporte:    0,
    /**
    * Vetor com os itinerários. De ZERO à DOIS (três no total)
    * @property itinerarios
    * @type {Array}
    */
    itinerarios:            [],
    /**
    * Resposta JSON da API
    * @property objeto_json
    * @type {JSON}
    */
    objeto_json:            &#x27;&#x27;,
    /**
    * Qual o itinerário a mostrar.
    * @property itinerario_mostrar
    * @type {Int}
    * @default &quot;0&quot;
    */
    itinerario_mostrar:     0,
    /**
    * Validações do formulário
    * @method validar
    * @returns {Boolean}
    */
    validar: function() {
        //Validação do formulário
        form = &#x27;form&#x27; + this.formulario;
        error = 0;
        date = $(form + &#x27; input#date&#x27;);
        time = $(form + &#x27; input#time&#x27;);
        if ( $(date).val() == &#x27;&#x27; )
        {
            $(date).parents(&#x27;.form-group&#x27;).addClass(&#x27;has-error&#x27;);
            ++error;
        }
        else
            --error;
        if ( $(time).val() == &#x27;&#x27; )
        {
            $(time).parents(&#x27;.form-group&#x27;).addClass(&#x27;has-error&#x27;);
            ++error;
        }
        else
            --error;
        //Desta forma a validação corre todos os campos
        if ( error &gt; 0 )
            return false;

        //Validar ponto de partida
        if ( typeof(m1) == &#x27;undefined&#x27; )
        {
            $(&#x27;h4.modal-title&#x27;).html(&#x27;Error&#x27;);
            $(&#x27;div.mensagem&#x27;).html(&#x27;&lt;i class=&quot;glyphicon glyphicon-exclamation-sign&quot;&gt;&lt;/i&gt; &#x27; + locale.messages.miss_origin);
            $(&quot;#myModal&quot;).modal();

            return false;
        }
        //Validar ponto de chegada
        if ( typeof(m2) == &#x27;undefined&#x27; )
        {
            $(&#x27;h4.modal-title&#x27;).html(&#x27;Error&#x27;);
            $(&#x27;div.mensagem&#x27;).html(&#x27;&lt;i class=&quot;glyphicon glyphicon-exclamation-sign&quot;&gt;&lt;/i&gt; &#x27; + locale.messages.miss_destiny);
            $(&quot;#myModal&quot;).modal();

            return false;
        }

        return true;
    },
    /**
    * Invoca a API e passa os dados necessários
    * @method invocar_api
    * @return {Object} ajax
    */
    invocar_api: function() {
        //Coordenadas
        fromPlace = m1.getLatLng().lat + &#x27;,&#x27; + m1.getLatLng().lng;
        toPlace = m2.getLatLng().lat + &#x27;,&#x27; + m2.getLatLng().lng;

        time = $(&#x27;form&#x27; + this.formulario + &#x27; input#time&#x27;).val();
        time = time.toLowerCase();
        $(&#x27;input#time&#x27;).val( (time).replace(/\s/g, &quot;&quot;) );
        form = $(&#x27;form&#x27; + this.formulario).serialize();

        if ( Rotas.tipo_api == &#x27;otp&#x27; )
        {
            //API da OST
            url = Config.api_url + &#x27;trips/plan/?&#x27; + 
                &#x27;fromPlace=&#x27; + fromPlace +
                &#x27;&amp;toPlace=&#x27; + toPlace +
                &#x27;&amp;&#x27; + form +
                &#x27;&amp;key=&#x27; + Config.api_key;
        }
        else
        {     
            //API da Cloudmade - Para teste apenas
            url = &#x27;http://routes.cloudmade.com/13e2ed112d194f36afc6c568fa65811d/api/0.3/&#x27; + 
              fromPlace + &#x27;,&#x27; + toPlace + &#x27;/foot.js&#x27;;
        }
        ajax = $.ajax({ url: url, dataType: &#x27;JSONP&#x27; });
        console.log(url);

        return ajax;
    },
    /**
    * Invoca a API e traça a rota
    * @method tracar
    * @return {Void}
    */
    tracar: function() {
       
        Rotas.clearMap();
        Rotas.itinerario_mostrar = 0;

        api = this.invocar_api();
        THIS = this;
        api
        //Deu certo
        .done( function(retorno){
            console.log( retorno );
            $(&#x27;a[href=&quot;#trip_resultados&quot;]&#x27;).show();
            $(&#x27;#Tab a[href=&quot;#trip_resultados&quot;]&#x27;).tab(&#x27;show&#x27;);
            // $(&#x27;div#trip_resultados&#x27;).empty();
            resultado = retorno;
            resultado = resultado.Objects;
            Rotas.objeto_json = resultado;

            //Depende do serviço, a resposta é diferente.
            if ( THIS.tipo_api == &#x27;otp&#x27; )
                objeto_json = THIS.formatar_otp( resultado );
            else
                objeto_json = THIS.formatar_cloudmade( retorno );
        })
        .fail(function(jqXHR, textStatus) {
            console.log( jqXHR );
            alert(&#x27;Ops &#x27; + textStatus);
            return false;
            //Mensagem de erro da chamada a API.
            /* A api pode entrar no .done() e mesmo
            assim não ser satisfatória para o utilizador.
            $(&#x27;div#trip_resultados&#x27;)
                .empty()
                .html(&#x27;Ocorreu um erro: &#x27; + textStatus);*/
        });
    },
    /**
    * Formatar resposta da Cloudmade
    * É apenas um teste e deverá ser removido
    * @method formatar_cloudmade
    * @return {Void}
    */
    formatar_cloudmade: function() {
        objeto_json = Rotas.objeto_json;
        var point, route, points = [];
        var instrucoes = [];
        for (var i=0; i&lt;objeto_json.route_geometry.length; i++)
        {
            point = new L.latLng(objeto_json.route_geometry[i][0], objeto_json.route_geometry[i][1]);
            points.push(point);
            //Gravar as instruções do caminho.
            if ( typeof(objeto_json.route_instructions[i]) != &#x27;undefined&#x27; )
            {
                var ins = {
                    distancia:  objeto_json.route_instructions[i][6].toFixed(2),
                    rua:        objeto_json.route_instructions[i][0],
                    direcao:    objeto_json.route_instructions[i][7],
                    norte_sul:  objeto_json.route_instructions[i][5]
                };
                instrucoes.push(ins);
            }
        }

        /* Esta variável não pode ser alterada. Ou pode, mas tem que ser em todos os sítios.
        Senão as rotas antigas continuam no mapa. */
        polyline = new L.Polyline(points, {
            weight:         3,
            opacity:        0.5,
            smoothFactor:   1
        }).addTo(map);
        this.escrever_direcoes(instrucoes);

        //Centraliza a rota dentro do mapa.
        // map.fitBounds(polyline.getBounds());
        polyline.bringToFront();
        console.log(points);
    },
    /**
    * Formata a resposta da OTP
    * @method formatar_otp
    * @return {Void}
    */
    formatar_otp: function() {
        var toLat, toLon;
        var route, points       = [];
        var instrucoes          = [];
        var cores               = [];
        var instrucoes_gerais   = [];
        var itinerarios         = [];
        objeto_json             = Rotas.objeto_json;
        $.each(objeto_json, function(index, value){
            if ( typeof(value.from.lat) != &#x27;undefined&#x27; || typeof(value.from.lon) != &#x27;undefined&#x27; )
            {
                Rotas.distanciaPe           = 0;
                Rotas.distanciaTransporte   = 0;
                Rotas.itinerarios           = [];
                i = 0;
                toLat = value.to.lat;
                toLon = value.to.lon;
                var latlngs = new L.latLng(value.from.lat, value.from.lon);
                points.push(latlngs);
                $.each(value.itineraries, function(index, legs){

                    //No primeiro momento, Rotas.itinerario_mostrar = 0;
                    if ( i == Rotas.itinerario_mostrar )
                    {
                        Rotas.clearMap();
                        var primeiro_itinerario = Rotas.desenhar_rota(value, legs, instrucoes_gerais, instrucoes, i, true);
                        var array_it = {
                            polyline:   primeiro_itinerario,
                            startTime:  legs.startTime,
                            duration:   legs.duration,
                            endTime:    legs.endTime,
                            transfers:  legs.transfers,
                        };
                        Rotas.itinerarios.push(array_it);
                        // console.log(array_it);

                        //Escrever as direções
                        Rotas.escrever_direcoes(instrucoes, i + 1);

                        //Informações globais
                        Rotas.informacoes(instrucoes_gerais, i);                        
                    }
                    //Os outros itinerários
                    else
                    {
                        var retorno = Rotas.desenhar_rota(value, legs, instrucoes_gerais, instrucoes, i, false);
                        var array_it = {
                            polyline:   retorno,
                            startTime:  legs.startTime,
                            duration:   legs.duration,
                            endTime:    legs.endTime,
                            transfers:  legs.transfers
                        };
                        Rotas.itinerarios.push(array_it);
                        // console.log(retorno);
                    }
                    ++i;
                });
            }
        });
        // console.log(&#x27;Contador &#x27; + i);

        Rotas.mostra_itinerarios();
        
        //Just in case
        if ( typeof(primeiro_itinerario) != &#x27;undefined&#x27; )
            primeiro_itinerario.bringToFront();
    },
    /**
    * Desenha as rotas (linhas) para cada trajeto
    *
    * @method desenhar_rota
    * @param {Object} value
    * @param {Object} legs
    * @param {Array} instrucoes_gerais
    * @param {Array} instrucoes
    * @param {Boolean} escrever_rota Se for true, desenha a rota no mapa
    * @return {Polyline}
    */
    desenhar_rota: function(value, legs, instrucoes_gerais, instrucoes, it, escrever_rota) {
        var ins_ger = {
            data_hora:      value.date,
            walkTime:       legs.walkTime,
            walkDistance:   legs.walkDistance,
            startTime:      legs.startTime,
            endTime:        legs.endTime,
            duration:       legs.duration
        };
        instrucoes_gerais.push(ins_ger);

        //Subcontador
        j = 0;
        var polylines = [];
        $.each(legs.legs, function(index, leg){
            //js/Polyline.encoded.js
            var fromEncoded = L.Polyline.fromEncoded(leg.legGeometry.points);

            //O retorno do fromEncoded é sempre um mega-objeto
            var obj_to_push = fromEncoded.getLatLngs();

            //Só é utilizada neste for.
            var points1 = [];
            for ( var i = 0; i &lt; obj_to_push.length; i++ )
            {
                var latlngs = new L.latLng(obj_to_push[i].lat, obj_to_push[i].lng);
                points1.push(latlngs);
            }
            //Necessário para distinguir os tipos de rota
            polyline = new L.Polyline(points1, {
                weight:         5,
                opacity:        0.8,
                smoothFactor:   1,
                color:          Rotas.cores(leg.mode)
            })
            .bindPopup(Rotas.info_popup(leg), { &#x27;minWidth&#x27;: 400 })
            .addTo(map);
            polylines.push(polyline);
            if ( escrever_rota == true )
            {
                // polyline.addTo(map);
                //@TODO: Verificar onde estão as paragens de autocarro.
                //Pontos para cada troca de rota
                Rotas.criar_pontos(leg, latlngs, it, true);

                //A rua quando for bus tem mais info (no. da carreira)
                var rua = &#x27;&lt;span class=&quot;modos modo_&#x27; + leg.mode + &#x27;&quot;&gt;&lt;/span&gt;&#x27; + &#x27; &#x27; + leg.to.name;
                if ( leg.mode == &#x27;BUS&#x27; )
                {
                    rua = &#x27;&lt;span class=&quot;modos modo_&#x27; + leg.mode + &#x27;&quot;&gt;&lt;/span&gt;&#x27; + &#x27; &#x27; +
                        leg.from.stopCode + &#x27; (Nº &#x27; + leg.route + &#x27;)&#x27;;
                }

                //Instruções. O step é array para gerar sub-steps - próximo bloco.
                var ins = {
                    distancia:  leg.distance.toFixed(2),
                    rua:        rua,
                    modo:       leg.mode,
                    direcao:    &#x27;&#x27;,
                    norte_sul:  &#x27;&#x27;,
                    steps:      []
                };
                instrucoes.push(ins);

                //@TODO: Há mais instruções fora dos steps.
                if ( leg.steps )
                {
                    $.each(leg.steps, function(index, step){
                        var passos = {
                            distancia:  step.distance.toFixed(2),
                            rua:        step.streetName,
                            modo:       leg.mode,
                            direcao:    step.relativeDirection,
                            norte_sul:  step.absoluteDirection
                        };
                        instrucoes[j].steps.push(passos);
                    });
                }

                //Informações dos transportes (lateral esquerda)
                if ( leg.mode == &quot;BUS&quot; )
                {
                    var div_ruas = &#x27;&lt;div class=&quot;div_ruas&quot;&gt;&#x27;
                        + &#x27;Paragem: (embarque) &#x27; + leg.from.stopCode + &#x27; às &#x27; + Rotas.formata_hora(leg.startTime, 2) + &#x27;&lt;br&gt;~&#x27;
                        + Math.floor(leg.duration / 60000) + &#x27; min.&lt;br&gt;&#x27;
                        + &#x27;Paragem: (desembarque) &#x27; + leg.to.stopCode + &#x27; às &#x27; + Rotas.formata_hora(leg.endTime, 2) + &#x27;&lt;br&gt;&#x27;
                        + leg.agencyName
                        + &#x27;&lt;/div&gt;&#x27;;
                    var info_paragens = {
                        distancia:  leg.distance.toFixed(2),
                        rua:        div_ruas,
                        direcao:    null,
                        norte_sul:  null
                    };
                    instrucoes[j].steps.push(info_paragens);
                    //Distância de transportes
                    Rotas.distanciaTransporte += leg.distance;
                }
                //Distância a lapatex
                else if ( leg.mode == &quot;WALK&quot; )
                    Rotas.distanciaPe += leg.distance;

                //Este contador serve para as sub-instruções
                ++j;
            }
            else
            {
                map.removeLayer(polyline);
                Rotas.criar_pontos(leg, latlngs, it, false);
            }
        });
        
        return polylines;
    },
    /**
    * Escreve no html as informações globais
    * do itinerário escolhido
    * @method informacoes
    * @param {Array} info Vetor com as informações
    * @return {Void}
    */
    informacoes: function(info, it) {
        ++it;
        $.each(info, function(index, value){
            var data_hora   = Rotas.formata_data(value.data_hora);
            var hora        = Rotas.formata_hora(value.data_hora);
            var duration    = Math.floor( value.duration / 60000 );
            var walkTime    = Math.floor( value.walkTime / 60 );
            var startTime   = Rotas.formata_hora(value.startTime);
            var endTime     = Rotas.formata_hora(value.endTime);
            var du_trans    = duration - walkTime;
            var walkTotal   = Rotas.distanciaPe + Rotas.distanciaTransporte;
            div_it = &#x27;div#coll_it&#x27; + it + &#x27; div.panel-body &#x27;;
            $(div_it + &#x27;div.info_trip&#x27;).removeClass(&#x27;escondido&#x27;);

            var div_trip = div_it + &#x27;div.info_trip &#x27;;
            // console.log(div_trip);
            $(div_trip + &#x27;dt.data_hora&#x27;).next(&#x27;dd&#x27;).html(data_hora);

            $(div_trip + &#x27;dt.distancia_total&#x27;).next(&#x27;dd&#x27;).children(&#x27;.texto&#x27;).html(walkTotal.toFixed(2) + &#x27; m&#x27;);
            $(div_trip + &#x27;dt.distancia_pe&#x27;).next(&#x27;dd&#x27;).html(Rotas.distanciaPe.toFixed(2) + &#x27; m&#x27;);
            $(div_trip + &#x27;dt.distancia_transportes&#x27;).next(&#x27;dd&#x27;).html(Rotas.distanciaTransporte.toFixed(2) + &#x27; m&#x27;);

            $(div_trip + &#x27;dt.duracao_total&#x27;).next(&#x27;dd&#x27;).children(&#x27;.texto&#x27;).html(duration + &#x27; min&#x27;);
            $(div_trip + &#x27;dt.duracao_pe&#x27;).next(&#x27;dd&#x27;).html(walkTime + &#x27; min&#x27;);
            $(div_trip + &#x27;dt.duracao_transportes&#x27;).next(&#x27;dd&#x27;).html(du_trans + &#x27; min&#x27;);
        });
        $(&#x27;div.info_trip&#x27;).show();
    },
    /**
    * Escreve as direções de cada parte da
    * rota como ul&gt;li
    * @method escrever_direcoes
    * @param {Array} direcoes Vetor com as direções
    * @return {Void}
    */
    escrever_direcoes: function(direcoes, it) {
        //data-api é que faz a mágica (HTML + CSS)
        var html = &#x27;&lt;ul class=&quot;direcoes&quot; data-api=&quot;resultados_&#x27; + this.tipo_api + &#x27;&quot;&gt;&#x27;;
        // console.log(&#x27;======= Direções ========&#x27;);
        // console.log(direcoes);
        // console.log(&#x27;======= Direções ========&#x27;);
        div_it = &#x27;div#coll_it&#x27; + it + &#x27; div.panel-body div.direcoes &#x27;;
        console.log(div_it);
        //Exibir a div de instruções
        $(div_it).animate({
            display: &#x27;block&#x27;
        }, 600).empty();
        //Gravo as direções
        var i = 1;
        $.each(direcoes, function(index, value){
            if ( typeof(value) != &#x27;undefined&#x27; )
            {
                html += Rotas.formata_html(value, i);
                //Subrotas
                if ( typeof(value.steps) != &#x27;undefined&#x27; )
                {
                    html += &#x27;&lt;ul class=&quot;escondido&quot;&gt;&#x27;;
                    $.each(value.steps, function(index2, step){
                        html += Rotas.formata_html(step);
                    });
                    html += &#x27;&lt;/ul&gt;&#x27;;
                }
                ++i;
                html += &#x27;&lt;/li&gt;&#x27;;
            }
        });

        //O clearfix existe por causa do float
        html += &#x27;&lt;/ul&gt;&lt;div class=&quot;clearfix&quot;&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;&#x27;;
        $(div_it).html(html);
    },
    /**
    * Coloca as informações com o HTML correto
    * O &#x60;&lt;li&gt;&#x60; é fechado depois do método ser invocado
    * @method formata_html
    * @param {Objeto} obj
    * @return {String} retorno
    */
    formata_html: function(obj, i) {
        retorno = &#x27;&lt;li&gt;&#x27;;
        retorno += &#x27;&lt;span class=&quot;norte_sul &#x27; + obj.norte_sul + &#x27;&quot;&gt;&lt;/span&gt; &lt;span class=&quot;direcao &#x27; + obj.direcao + &#x27;&quot;&gt;&lt;/span&gt;&#x27;;
        retorno += &#x27;&lt;span class=&quot;texto&quot;&gt; &#x27; + obj.rua;
        if ( obj.modo == &quot;WALK&quot; )
            retorno += &#x27; em &#x27; + obj.distancia + &#x27; metros&#x27;;

        retorno += &#x27;&lt;/span&gt;&lt;div class=&quot;clearfix&quot;&gt;&lt;/div&gt;&#x27;;
        // console.log(obj);

        return retorno;
    },
    /**
    * Cria um html (&#x60;&lt;ul&gt;&#x60;) com os 3 itinerários
    * @method mostra_itinerarios
    * @return {Void}
    */
    mostra_itinerarios: function() {
        // var html = &#x27;&lt;ul class=&quot;ul_itinerarios&quot;&gt;&#x27;;
        // var html = &#x27;&#x27;;

        for ( j = 1; j &lt;= 3; ++j )
        {
            $(&#x27;div.it&#x27; + j).show();
        }
        var contador = 1;
        $.each(Rotas.itinerarios, function(index, it){
            var inicio, fim, duracao;
            var html = &#x27;&#x27;;
            inicio  = Rotas.formata_hora(it.startTime);
            fim     = Rotas.formata_hora(it.endTime);
            duracao = Math.floor(it.duration / 60000);

            div_it = &#x27;div.it&#x27; + contador + &#x27; &#x27;;
            i = contador - 1;

            $(div_it + &#x27;a[href=&quot;#coll_it&#x27; + contador + &#x27;&quot;]&#x27;)
                .html(contador + &#x27;. &#x27; + inicio + &#x27; - &#x27; + fim + &#x27; (&#x27; + duracao + &#x27; min)&#x27;);
            $(div_it + &#x27;a[href=&quot;#coll_it&#x27; + contador + &#x27;&quot;]&#x27;).attr(&#x27;data-itinerario&#x27;, i);
            // $(div_it + &#x27;div.panel-body&#x27;)
            //     .html(it.transfers + &#x27;&lt;br&gt;&#x27;);

            // html = index + &#x27;. &#x27; + inicio + &#x27; - &#x27; + fim + &#x27; (&#x27; + duracao + &#x27; min)&#x27;;
            // $(&#x27;a[href=&quot;it&#x27; + contador + &#x27;&quot;]&#x27;).html(html);
            // html += &#x27;&lt;li data-itinerario=&quot;&#x27; + index + &#x27;&quot;&gt;&#x27;
            //     + &#x27;&lt;a href=&quot;#&quot; data-itinerario=&quot;&#x27; + index + &#x27;&quot;&gt;&#x27; + contador + &#x27;. &#x27;
            //     + inicio + &#x27; - &#x27; + fim
            //     + &#x27;&lt;span class=&quot;pull-right duracao&quot;&gt;&#x27; + duracao + &#x27; mins&lt;/span&gt;&#x27;
            //     + &#x27;&lt;br&gt;&#x27;
            //     + &#x27;Transferências: &#x27; + it.transfers
            //     + &#x27;&lt;/a&gt;&lt;/li&gt;&#x27;;

            ++contador;
        });
        // html += &#x27;&lt;/ul&gt;&#x27;;
        $(&#x27;div.itinerarios&#x27;).removeClass(&#x27;escondido&#x27;);
        // $(&#x27;div.itinerarios ul&#x27;)
        //     .empty()
        //     .html(html);

        //Quem vai ser removido
        for ( j = contador; j &lt;= 3; ++j )
        {
            $(&#x27;div.it&#x27; + j).hide();
        }

        console.log(Rotas.itinerarios);
    },
    /**
    * Define as cores para cada tipo de rota
    * @method cores
    * @param {String} modo
    * @return {String} cor em hexadecimal
    */
    cores: function(modo) {
        if ( modo == &#x27;WALK&#x27; )
            return &#x27;#111&#x27;;
        else if ( modo == &#x27;BUS&#x27; )
            return &#x27;#FF0000&#x27;;
        else
            return &#x27;#3E85C3&#x27;;
    },
    /**
    * Limpa todos os percursos.
    * @method clearMap
    * @return {Void}
    */
    clearMap: function() {
        //É meio hack, mas o plugin não tem nada parecido.
        for(i in map._layers) {
            //Aqui é melhor testar com constante ao invés do typeof
            if(map._layers[i]._path != undefined) {
                try
                {
                    map.removeLayer(map._layers[i]);
                }
                catch(e)
                {
                    console.log(&quot;Verifique isso pois deu problema &quot; + e + map._layers[i]);
                }
            }
        }
        //Apaga também os pontinhos (paragens e desvios)
        if ( typeof(pontos) != &#x27;undefined&#x27; )
        {
            for ( var i = 0; i &lt; pontos.length; ++i )
                map.removeLayer(pontos[i]);
            pontos = [];
        }
    },
    /**
    * Cria um pop-up na rota com
    * as informações da mesma
    * @method info_popup
    * @param {Object} obj
    * @return {String}
    */
    info_popup: function(obj) {
        var info = &#x27;&lt;section class=&quot;info_popup row&quot;&gt;&#x27;;
        if ( obj.mode == &#x27;BUS&#x27; )
        {
            info += &#x27;&lt;div class=&quot;col-md-4 first&quot;&gt;Autocarro&lt;/div&gt;&lt;div class=&quot;col-md-8 first&quot;&gt;&#x27; + obj.route + &#x27;&lt;/div&gt;&#x27;;
            info += &#x27;&lt;div class=&quot;col-md-4&quot;&gt;Entrar na paragem:&lt;/div&gt;&lt;div class=&quot;col-md-8&quot;&gt;&#x27; + obj.from.stopCode + &#x27;&lt;/div&gt;&#x27;;
            info += &#x27;&lt;div class=&quot;col-md-4&quot;&gt;Descer na paragem:&lt;/div&gt;&lt;div class=&quot;col-md-8&quot;&gt;&#x27; + obj.to.stopCode + &#x27;&lt;/div&gt;&#x27;;
            info += &#x27;&lt;div class=&quot;col-md-4&quot;&gt;Partida às:&lt;/div&gt;&lt;div class=&quot;col-md-8&quot;&gt;&#x27; + this.formata_hora(obj.startTime) + &#x27;&lt;/div&gt;&#x27;;
            info += &#x27;&lt;div class=&quot;col-md-4&quot;&gt;Chegada às:&lt;/div&gt;&lt;div class=&quot;col-md-8&quot;&gt;&#x27; + this.formata_hora(obj.endTime) + &#x27;&lt;/div&gt;&#x27;;
            info += &#x27;&lt;div class=&quot;col-md-4&quot;&gt;Serviço prestado por:&lt;/div&gt;&lt;div class=&quot;col-md-8&quot;&gt;&#x27; + obj.agencyName + &#x27;&lt;/div&gt;&#x27;;
        }
        else
            info += &#x27;@TODO Informações do caminho por outros métodos (a pé, bike, carro, etc...)&#x27;;

        return info + &#x27;&lt;/section&gt;&#x27;;
    },
    /**
    * Criar pontos (bolinhas) para cada tipo de troca de rota
    * @method criar_pontos
    * @param {Object} leg
    * @param {Object} latlngs
    * @param {Int} it
    * @param {Boolean} escrever
    * @return {Void}
    */
    criar_pontos: function(leg, latlngs, it, escrever) {
        //Bolinhas para troca de tipo de rota
        if ( leg.mode == &#x27;BUS&#x27; )
            icone_info = leg.to.stopCode;
        else
            icone_info = leg.to.name;
        icone = L.icon({
            iconUrl: &#x27;images/map/trip/xferdisk.png&#x27;
        });
        //Crio a bolinha
        marker = L.marker( latlngs, {
            draggable:  false,
            icon:       icone
        })
        .bindPopup(icone_info);
        if ( escrever == true )
        {
            marker.addTo(map);
            pontos.push(marker);
        }

        //este array (var pontos) serve para apagar aquando da atualização dos marcadores
        // pontos.push(marker);
        // console.log( pontos );
    },
    /**
    * Transforma um timestamp em horas:minutos
    * @method formata_hora
    * @param {Timestamp} hora
    * @return {String} hours:minutes
    */
    formata_hora: function(hora) {
        date    = new Date(hora);
        hours   = Rotas.zero_data(date.getHours());
        minutes = Rotas.zero_data(date.getMinutes(), 2);

        return hours + &#x27;:&#x27; + minutes;
    },
    /**
    * Transforma um timestamp em data mais hora:minutos
    * @method formata_data
    * @param {Timestamp} data
    * @return {String}
    */
    formata_data: function(data) {
        var data_obj = new Date(data);

        data = Rotas.zero_data(data_obj.getDate(), 2)
            + &#x27;/&#x27;
            + Rotas.zero_data(data_obj.getMonth() + 1, 2)
            + &#x27;/&#x27;
            + Rotas.zero_data(data_obj.getFullYear(), 4);
        hours = data_obj.getHours();
        minutes = data_obj.getMinutes();

        // console.log( data_obj );

        return data + &#x27; &#x27; + hours + &#x27;:&#x27; + minutes;
    },
    /**
    * Coloca um zero a mais na data (a esquerda)
    * @method zero_data
    * @param {Int} num
    * @param {Int} count
    * @return {Int} z
    */
    zero_data: function(num, count) {
        var z = num + &#x27;&#x27;;
        while (z.length &lt; count) {
            z = &quot;0&quot; + z;
        }

        return z;
    },
    /**
    * Corre todos os itinerarios e os esconde
    * @method oculta_itinerarios
    * @return {Void}
    */
    oculta_itinerarios: function() {
        $.each(Rotas.itinerarios, function(index, value){
            $.each(value.polyline, function(index2, pol){
                map.removeLayer(pol);
            });
        });

        // console.log(pontos);
        $.each(pontos, function(index, ponto){
            map.removeLayer(ponto);
        });
    },
    /**
    * Mostra apenas o primeiro itinerário
    * @method mostra_primeiro_itinerario
    * @Return {Void}
    */
    mostra_primeiro_itinerario: function() {
        $.each(Rotas.itinerarios[Rotas.itinerario_mostrar], function(index, value){
            $.each(value, function(index2, pol){
                map.addLayer(pol);
            });
        });
        $.each(pontos, function(index, ponto){
            map.addLayer(ponto);
        });
    },
    /**
    * Mostra o itinerário it
    * @method mostra_itinerario
    * @param {Int} it Itinerário a ser mostrado
    * @return {Void}
    */
    mostra_itinerario: function(it) {
        $.each(Rotas.itinerarios[it], function(index, value){
            $.each(value, function(index2, pol){
                map.addLayer(pol);
            });
        });
        //Só mostro quando for o primeiro it
        if ( it == Rotas.itinerario_mostrar )
        {
            $.each(pontos, function(index, ponto){
                map.addLayer(ponto);
            });
        }
    }
};

$(&#x27;body&#x27;).on(&#x27;mouseover&#x27;, &#x27;div.itinerarios h4.panel-title a&#x27;, function(e){
    id_itinerario = $(this).data(&#x27;itinerario&#x27;);

    Rotas.oculta_itinerarios();
    Rotas.mostra_itinerario(id_itinerario);
});
$(&#x27;body&#x27;).on(&#x27;mouseout&#x27;, &#x27;div.itinerarios h4.panel-title a&#x27;, function(e){
    id_itinerario = $(this).data(&#x27;itinerario&#x27;);

    Rotas.oculta_itinerarios();
    Rotas.mostra_primeiro_itinerario();
});
$(&#x27;body&#x27;).on(&#x27;click&#x27;, &#x27; div.itinerarios h4.panel-title a&#x27;, function(e){
    id_itinerario = $(this).data(&#x27;itinerario&#x27;);

    Rotas.itinerario_mostrar = id_itinerario;
    Rotas.formatar_otp();
});
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
